name: Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'gem-viz/**'
  workflow_dispatch:

env:
  DO_SPACES_BUCKET: ejthirdbear
  DO_SPACES_REGION: sfo3
  DO_SPACES_ENDPOINT: https://sfo3.digitaloceanspaces.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: gem-viz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gem-viz/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
          PUBLIC_MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Configure AWS CLI for DO Spaces
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          aws-region: us-east-1

      - name: Deploy to Digital Ocean Spaces
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "Deploying v${VERSION} to DO Spaces..."
          aws s3 sync build s3://${DO_SPACES_BUCKET}/gem-viz/v${VERSION}/ \
            --endpoint-url ${DO_SPACES_ENDPOINT} \
            --acl public-read \
            --cache-control "public, max-age=3600" \
            --delete

      - name: Deployment summary
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${DO_SPACES_BUCKET}.${DO_SPACES_REGION}.digitaloceanspaces.com/gem-viz/v${VERSION}/" >> $GITHUB_STEP_SUMMARY
